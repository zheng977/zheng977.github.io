---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

interface Props {
  images: {
    src: ImageMetadata;
    alt: string;
    caption?: string;
  }[];
}

const { images } = Astro.props;
---

<div class="carousel-container relative w-full max-w-4xl mx-auto group">
  <div class="carousel-track flex overflow-x-auto snap-x snap-mandatory scroll-smooth no-scrollbar rounded-lg shadow-md bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700">
    {
      images.map((img, index) => (
        <div class="carousel-item min-w-full snap-center flex flex-col items-center justify-center p-4">
          <Image src={img.src} alt={img.alt} class="max-h-[600px] w-auto object-contain rounded" />
          {img.caption && (
            <p class="mt-2 text-sm text-zinc-600 dark:text-zinc-400 text-center italic">
              {img.caption}
            </p>
          )}
        </div>
      ))
    }
  </div>

  {/* Navigation Buttons */}
  <button class="carousel-prev absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 dark:bg-black/50 hover:bg-white dark:hover:bg-black text-zinc-800 dark:text-white p-2 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-30" aria-label="Previous slide">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
  </button>
  <button class="carousel-next absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 dark:bg-black/50 hover:bg-white dark:hover:bg-black text-zinc-800 dark:text-white p-2 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-30" aria-label="Next slide">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
  </button>

  {/* Indicators */}
  <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2">
    {images.map((_, index) => (
      <button
        class="carousel-indicator w-2 h-2 rounded-full bg-zinc-400/50 hover:bg-zinc-600 dark:hover:bg-zinc-200 transition-colors"
        data-index={index}
        aria-label={`Go to slide ${index + 1}`}
      ></button>
    ))}
  </div>
</div>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>

<script>
  class Carousel {
    container: HTMLElement;
    track: HTMLElement;
    prevBtn: HTMLButtonElement | null;
    nextBtn: HTMLButtonElement | null;
    indicators: NodeListOf<HTMLButtonElement>;
    itemWidth: number;

    constructor(container: HTMLElement) {
      this.container = container;
      this.track = container.querySelector('.carousel-track') as HTMLElement;
      this.prevBtn = container.querySelector('.carousel-prev');
      this.nextBtn = container.querySelector('.carousel-next');
      this.indicators = container.querySelectorAll('.carousel-indicator');
      this.itemWidth = this.track.clientWidth;

      this.init();
    }

    init() {
      // Update item width on resize
      window.addEventListener('resize', () => {
        this.itemWidth = this.track.clientWidth;
      });

      // Button listeners
      this.prevBtn?.addEventListener('click', () => this.scroll('prev'));
      this.nextBtn?.addEventListener('click', () => this.scroll('next'));

      // Indicator listeners
      this.indicators.forEach((indicator) => {
        indicator.addEventListener('click', (e) => {
          const index = parseInt((e.target as HTMLElement).dataset.index || '0');
          this.scrollTo(index);
        });
      });

      // Scroll listener to update active indicator
      this.track.addEventListener('scroll', () => this.updateActiveIndicator());
      
      // Initial update
      this.updateActiveIndicator();
    }

    scroll(direction: 'prev' | 'next') {
      const scrollAmount = direction === 'next' ? this.itemWidth : -this.itemWidth;
      this.track.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    }

    scrollTo(index: number) {
      const scrollAmount = index * this.itemWidth;
      this.track.scrollTo({ left: scrollAmount, behavior: 'smooth' });
    }

    updateActiveIndicator() {
      const scrollLeft = this.track.scrollLeft;
      const activeIndex = Math.round(scrollLeft / this.itemWidth);

      this.indicators.forEach((indicator, index) => {
        if (index === activeIndex) {
          indicator.classList.add('bg-zinc-800', 'dark:bg-white', 'scale-125');
          indicator.classList.remove('bg-zinc-400/50');
        } else {
          indicator.classList.remove('bg-zinc-800', 'dark:bg-white', 'scale-125');
          indicator.classList.add('bg-zinc-400/50');
        }
      });
    }
  }

  // Initialize all carousels
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('.carousel-container').forEach(el => {
      new Carousel(el as HTMLElement);
    });
  });
  
  // Fallback for non-view-transitions
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.carousel-container').forEach(el => {
      new Carousel(el as HTMLElement);
    });
  });
</script>

